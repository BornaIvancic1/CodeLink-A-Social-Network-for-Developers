<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages</title>

    <style>
       
        .message-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            margin-bottom: 10px;

        }

        .message-sent {
            background-color: rgba(252, 207, 103, 0.5);
            color: rgba(11, 64, 156, 1);
            font-weight: 600;
            padding: 13px;
            max-width: 70%;
            word-wrap: break-word;
            margin: 10px 10px 10px auto; 
            text-shadow: none;
            border-radius: 30px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }

        .message-received {
            background-color: rgba(11, 64, 156, 0.5);
            color: rgba(255, 206, 99, 1);
            font-weight: 600;
            padding: 13px;
            max-width: 70%;
            word-wrap: break-word;
            margin: 10px auto 10px 10px; 
            text-shadow: none;
            border-radius: 30px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }

       
        .Osobe {
            list-style-type: none;
            margin-top: 10px;
            padding: 5px;
        }

            .Osobe li {
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
                margin-bottom: 5px;
                background-color: rgba(11, 64, 156, 0.38);
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 20px;
                margin: 10px;
                color: #FFCE63 !important;
                font-weight: 550;
                font-size: 20px;
                text-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
                cursor: pointer;
            }

                .Osobe li.selected {
                    background-color: rgba(11, 64, 156, 0.6);
                }

        #closeMessagesBtn {
            border-radius: 30px;
            transition: 0.5s box-shadow;
        }

            #closeMessagesBtn:hover {
            background-color: red;
            box-shadow: 0 0 20px red;
        }
        

        .textplacer {
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            background-color: rgba(0, 93, 255, 0.53);
            width: 80%;
            margin-top: 10px;
            margin-bottom: 10px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            padding: 10px;
            border-radius: 30px;
            box-sizing: border-box;
        }

        .iconsd {
            margin: 0 !important;
        }

        #messagesContainer {
            margin-top: 220px;
            background-color: rgba(255, 255, 255, 0.38);
            border-radius: 30px;
            min-height: 500px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow-y: auto; 
            padding: 20px;

        }

        .textplacer-container {
          
            position: absolute;
            bottom: 10px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .btn {
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            border: none !important;
        }

        .send {
            margin-right: 20px;
            border-radius: 30px;
            background-color: green;
            transition: 0.5s box-shadow ;
        }

            .send:hover{
                background-color: green;
                box-shadow: 0 0 20px green;
              
            }

      
        #messages {
            overflow-y: auto;
            max-height: 80%;
            padding:10px;
            box-shadow: inset 0px 0px 6px 6px rgba(11, 64, 156, 1);
            margin:10px;
          border-top-left-radius:30px;
          border-bottom-left-radius:30px;
        }    

        .user{
            padding:50px !important;
            border-radius:50px;
         height:90%;
        }
    </style>
</head>
<body>
    <div style="display: flex;">
        <div id="usersList" style="width: 200px; background-color: rgba(11, 64, 156, 0.38); border-radius: 50px; padding: 25px; margin-right: 20px; margin-top: 220px !important;box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);">
            <ul class="Osobe">
                @foreach (var user in Model)
                {
                    <li class="user" data-user-id="@user.Id">@user.FirstName @user.LastName</li>
                }
            </ul>
        </div>

        <div id="messagesContainer"  style="display: none; flex: 1; position: relative;   box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);  ">
            <button class="btn btn-danger" id="closeMessagesBtn" style="margin-left: auto; display: block;">
                <span class="material-symbols-outlined iconsd">
                    cancel
                </span>
            </button>
            <div id="messages" class="message-container"></div>
            <div class="textplacer-container">
                <input type="text" class="textplacer">
                <button class="btn btn-primary send">
                    <span class="material-symbols-outlined iconsd">
                        send
                    </span>
                </button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const users = document.querySelectorAll(".user");
            const messagesContainer = document.getElementById("messagesContainer");
            const closeMessagesBtn = document.getElementById("closeMessagesBtn");

            users.forEach(user => {
                user.addEventListener("click", async () => {
                    messagesContainer.style.opacity = 0; 
                    messagesContainer.style.display = "block";
                    fadeIn(messagesContainer); 
                    const receiverId = user.dataset.userId;
                    $('#messagesContainer').data('receiver-id', receiverId);
                    fetchMessages(receiverId);
                });
            });

            closeMessagesBtn.addEventListener("click", function () {
                fadeOut(messagesContainer); 
            });

            $('.send').click(function () {
                var senderId = '@(ViewBag.UserId as string)';
                var receiverId = $('#messagesContainer').data('receiver-id');
                var message = $('.textplacer').val();
                if (message.trim() !== '') {
                    if (receiverId) {
                        sendMessage(senderId, receiverId, message);
                    } else {
                        alert('Please select a recipient!');
                    }
                } else {
                    alert('Please enter a message!');
                }
            });
        });

        function fadeIn(element) {
            var op = 0.1;  
            var translateY = 100; 
            var increment = 10; 
            var intervalTime = 50;

            function animate() {
                if (op >= 1) {
                    cancelAnimationFrame(timer);
                    return;
                }
                element.style.opacity = op;
                element.style.transform = 'translateY(-' + translateY + 'px)';
                op += 0.1;
                translateY -= increment;
                timer = requestAnimationFrame(animate);
            }
            var timer = requestAnimationFrame(animate);
        }

        function fadeOut(element) {
            var op = 1;  
            var translateY = 0;
            var decrement = 10;
            var intervalTime = 50; 

            function animate() {
                if (op <= 0.1) {
                    cancelAnimationFrame(timer);
                    element.style.display = 'none'; 
                    return;
                }
                element.style.opacity = op;
                element.style.transform = 'translateY(' + translateY + 'px)';
                op -= 0.1;
                translateY += decrement;
                timer = requestAnimationFrame(animate);
            }
            var timer = requestAnimationFrame(animate);
        }


        function fetchMessages(receiverId) {
            $.ajax({
                type: 'GET',
                url: 'https://localhost:7156/api/Message/' + '@(ViewBag.UserId as string)' + '/' + receiverId,
                success: function (response) {
                    displayMessages(response);
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching messages:', error);
                }
            });
        }

        function displayMessages(messages) {
            $('#messages').empty();
            messages.forEach(function (message) {
                var messageDiv = $('<div>').text(message.content);
                if (message.senderId == '@(ViewBag.UserId as string)') {
                    messageDiv.addClass('message-sent');
                } else {
                    messageDiv.addClass('message-received');
                }
                $('#messages').append(messageDiv);
            });
        }

        function sendMessage(senderId, receiverId, message) {
            $.ajax({
                type: 'POST',
                url: 'https://localhost:7156/api/Message/' + senderId + '/' + receiverId + '/' + message,
                contentType: 'application/json',
                success: function (response) {
                    console.log('Message sent successfully!');
                    $('.textplacer').val('');
                    fetchMessages(receiverId);
                },
                error: function (xhr, status, error) {
                    console.error('Error sending message:', error);
                }
            });
        }
    </script>

</body>
</html>
